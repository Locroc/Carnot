<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Learning Interface</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f0f2f5;
            --panel-bg: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --active-section: #28a745;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --progress-bar-color: #007bff;
            --progress-bar-bg: #e9ecef;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            background-color: var(--panel-bg);
            padding: 20px 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }
        
        .progress-svg-container { position: absolute; top: 55%; left: 0; width: 100%; height: 50px; z-index: 1; overflow: hidden; }
        #progress-arrow-bg, #progress-arrow-fg { stroke-width: 8; stroke-linecap: round; fill: none; transition: all 0.4s ease-in-out; }
        #progress-arrow-bg { stroke: var(--progress-bar-bg); }
        #progress-arrow-fg { stroke: var(--progress-bar-color); }
        .sections-container { display: flex; gap: 20px; position: relative; z-index: 2; }
        .section-box { padding: 10px; box-sizing: border-box; text-align: center; border: 2px solid var(--border-color); border-radius: 8px; background-color: var(--panel-bg); cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        
        /* Flex-grow rules for the 2:3:2:2:4 ratio */
        .section-box:nth-child(1) { flex-grow: 2; }
        .section-box:nth-child(2) { flex-grow: 3; }
        .section-box:nth-child(3) { flex-grow: 2; }
        .section-box:nth-child(4) { flex-grow: 2; }
        .section-box:nth-child(5) { flex-grow: 4; }

        .section-icon { width: 40px; height: 40px; border-radius: 5px; background-color: transparent; background-size: cover; background-position: center; }
        .section-box:nth-child(1) .section-icon { background-image: url('https://placehold.co/60x60/007bff/FFFFFF/png?text=1'); }
        .section-box:nth-child(2) .section-icon { background-image: url('https://placehold.co/60x60/28a745/FFFFFF/png?text=2'); }
        .section-box:nth-child(3) .section-icon { background-image: url('https://placehold.co/60x60/dc3545/FFFFFF/png?text=3'); }
        .section-box:nth-child(4) .section-icon { background-image: url('https://placehold.co/60x60/ffc107/FFFFFF/png?text=4'); }
        .section-box:nth-child(5) .section-icon { background-image: url('https://placehold.co/60x60/17a2b8/FFFFFF/png?text=5'); }
        .section-title { font-weight: bold; font-size: 0.9em; }
        .section-box.completed { border-color: var(--primary-color); background-color: #e7f3ff; }
        .section-box.active { border-color: var(--active-section); background-color: #eaf7ed; transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        main { flex-grow: 1; display: flex; padding: 30px; gap: 30px; }
        #text-panel, #graphics-panel { background-color: var(--panel-bg); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
        #text-panel { flex: 0 0 30%; padding: 25px; overflow-y: auto; }
        #graphics-panel { flex: 1 1 70%; position: relative; }
        .interactive-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.2rem; color: var(--secondary-color); opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s; }
        .interactive-page.active-page { opacity: 1; visibility: visible; }
        footer { padding: 15px 30px; background-color: var(--panel-bg); border-top: 1px solid var(--border-color); text-align: center; }
        .nav-button { padding: 12px 24px; border: none; background-color: var(--primary-color); color: white; border-radius: 5px; font-size: 1rem; font-weight: bold; cursor: pointer; margin: 0 10px; transition: background-color 0.2s; }
        .nav-button:hover { background-color: #0056b3; }
        .nav-button:disabled { background-color: var(--secondary-color); cursor: not-allowed; }
        
        .feedback { margin-top: 15px; font-weight: bold; }
        .feedback.correct { color: var(--success-color); }
        .feedback.incorrect { color: var(--danger-color); }

        .train-interaction-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .train-image-wrapper { position: relative; width: 800px; height: 450px; overflow: hidden; border-radius: 8px; background-color: #f8f8f8; margin-bottom: 20px; }
        #train-image-scaler { width: 100%; height: 100%; transition: transform 0.3s ease-in-out; transform-origin: 20% 98%; }
        #train-image-scaler img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; user-select: none; transition: opacity 0.2s ease-in-out; }
        #piston-schematic { opacity: 0; }
        .hotspot { position: absolute; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease, background-color 0.2s ease; border-radius: 5px; }
        .correctly-answered .hotspot { pointer-events: none; }
        .hotspot:hover { background-color: rgba(0, 123, 255, 0.2); }
        #train-feedback { margin-top: 10px; font-size: 1em; }
        #zoom-slider-container { width: 80%; max-width: 500px; margin-top: 10px; visibility: hidden; opacity: 0; transition: opacity 0.3s ease; }
        #zoom-slider-container.active { visibility: visible; opacity: 1; }

        /* --- Schematic Styles --- */
        .schematic-container {
            width: 90%;
            max-width: 600px;
        }
        .schematic-container text {
            fill: #333;
        }

        /* --- Pop-up Quiz Styles --- */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }
        .popup-quiz {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background-color: var(--panel-bg);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001;
            text-align: left;
        }
        .popup-quiz h3 {
            margin-top: 0;
        }
        .quiz-options label {
            display: block;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .quiz-options label:hover {
            background-color: #f0f2f5;
        }
        .popup-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            background: none;
            border: none;
            cursor: pointer;
        }
        .popup-overlay.hidden, .popup-quiz.hidden {
            display: none;
        }
        .svg-button {
            cursor: pointer;
        }

        /* --- Reversibility Interaction Styles --- */
        .reversibility-container {
            width: 90%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .parameter-display {
            display: flex;
            justify-content: space-around;
            width: 100%;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-family: monospace;
            font-size: 1.1em;
        }
        .piston-system {
            width: 100%;
            padding: 20px 0;
        }
        .cylinder {
            position: relative;
            height: 100px;
            background-color: #e9ecef;
            border: 3px solid #6c757d;
            border-radius: 5px;
        }
        .piston {
            position: absolute;
            top: 0;
            left: 20%; /* Initial position */
            width: 20%;
            height: 100%;
            background-color: #343a40;
            border-right: 5px solid #212529;
            box-sizing: border-box;
        }
        .slider-control {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        .slider-control input[type="range"] {
            flex-grow: 1;
        }
        .slider-control span {
            font-weight: bold;
        }

        .piston-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows slider interaction */
        }
        .shaft {
            fill: #6c757d;
        }
        .opening {
            fill: #adb5bd;
        }

    </style>
</head>
<body>
    <header>
        <div class="progress-svg-container">
            <svg width="100%" height="100%" viewBox="0 0 1200 50" preserveAspectRatio="none">
                <line id="progress-arrow-bg" x1="0" y1="25" x2="1200" y2="25" />
                <line id="progress-arrow-fg" x1="0" y1="25" x2="0" y2="25" />
            </svg>
        </div>
        <div class="sections-container">
            <div class="section-box" data-section="1"><div class="section-icon"></div><span class="section-title">Reality</span></div>
            <div class="section-box" data-section="2"><div class="section-icon"></div><span class="section-title">Idealization</span></div>
            <div class="section-box" data-section="3"><div class="section-icon"></div><span class="section-title">Discretization</span></div>
            <div class="section-box" data-section="4"><div class="section-icon"></div><span class="section-title">Geometric</span></div>
            <div class="section-box" data-section="5"><div class="section-icon"></div><span class="section-title">Algebraic</span></div>
        </div>
    </header>

    <main>
        <aside id="text-panel"></aside>
        <section id="graphics-panel">
            <div class="interactive-page" data-page-index="0">
                <div class="train-image-wrapper">
                    <img src="Engine.jpg" alt="A steam train engine" style="max-width: 100%; max-height: 100%;"> 
                </div>
            </div>
            
            <div class="interactive-page" data-page-index="1">
                <div class="train-interaction-container" id="train-interaction-container">
                    <div class="train-image-wrapper">
                        <div id="train-image-scaler">
                            <img id="main-engine-image" src="Engine.jpg" alt="Detailed steam train illustration">
                            <img id="piston-schematic" src="Piston.svg" alt="Schematic of a steam engine piston" style="max-width: 100%; max-height: 100%;">
                        </div>
                        <div class="hotspot" style="left: 23%; top: 22%; width: 9%; height: 20%;" data-part="chimney"></div>
                        <div class="hotspot" style="left: 5%; top: 70%; width: 14%; height: 20%;" data-part="cowcatcher"></div>
                        <div class="hotspot" style="left: 23%; top: 65%; width: 15%; height: 20%;" data-part="piston-area" data-correct="true"></div>
                        <div class="hotspot" style="left: 40%; top: 64%; width: 40%; height: 30%;" data-part="wheels"></div>
                        <div class="hotspot" style="left: 34%; top: 42%; width: 34%; height: 22%;" data-part="boiler"></div>
                        <div class="hotspot" style="left: 69%; top: 31%; width: 16%; height: 30%;" data-part="cab"></div>
                    </div>
                    <div id="train-feedback" class="feedback">Click on the part where heat energy is converted into motion!</div>
                    <div id="zoom-slider-container">
                        <label for="train-zoom-slider">Zoom & Reveal:</label>
                        <input type="range" id="train-zoom-slider" min="0" max="100" value="0" step="1" style="width: 100%;">
                    </div>
                </div>
            </div>
            
            <div class="interactive-page" data-page-index="2">
                <div class="schematic-container">
                    <svg viewBox="0 0 500 382" preserveAspectRatio="xMidYMid meet">
                        <a id="hot-source-btn" class="svg-button">
                            <rect x="50" y="10" width="400" height="80" fill="#fff3e0" stroke="#ffb74d" stroke-width="2" rx="10"></rect>
                            <text x="250" y="45" font-family="sans-serif" font-size="20" text-anchor="middle" font-weight="bold">Hot Source</text>
                            <text x="250" y="70" font-family="sans-serif" font-size="18" text-anchor="middle">Temperature: T<tspan dy ="7" font-size="10">Source</tspan></text>
                        </a>
                        
                        <a id="cold-sink-btn" class="svg-button">
                            <rect x="50" y="300" width="400" height="80" fill="#e3f2fd" stroke="#90caf9" stroke-width="2" rx="10"></rect>
                            <text x="250" y="335" font-family="sans-serif" font-size="20" text-anchor="middle" font-weight="bold">Cold Sink</text>
                            <text x="250" y="360" font-family="sans-serif" font-size="18" text-anchor="middle">Temperature: T<tspan dy ="7" font-size="10">Sink</tspan></text>
                        </a>

                        <g id="g3" transform="translate(-140.971138,-380.62569) scale(4.5)"><path id="rect1" style="fill:#3e5563;fill-opacity:1;stroke-width:0.301507;stroke-dasharray:0.301507, 0.301507" d="m 69.971523,119.62569 h 26.293125 v 1.39468 H 71.095122 v 11.78379 h 25.169692 v 1.39535 H 69.971132 Z"></path><path id="rect2-4" style="fill:#80afae;stroke-width:0.460031;stroke-dasharray:0.460031, 0.460031" d="m 81.200795,127.34233 v -1.33445 h 19.133375 v 1.33445 z m -0.795107,-6.29612 h 0.928055 v 11.74923 h -0.928055 z"></path></g>
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#d32f2f"></polygon>
                            </marker>
                            <marker id="arrowhead-work" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#28a745"></polygon>
                            </marker>
                            <marker id="arrowhead-cold" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#007bff"></polygon>
                            </marker>
                            <marker id="arrowhead-diss" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#fff200"></polygon>
                            </marker>
                        </defs>
                        <line x1="250" y1="90" x2="250" y2="115" stroke="#d32f2f" stroke-width="4" marker-end="url(#arrowhead)"></line>
                        <text x="275" y="128" font-family="sans-serif" font-size="24" font-style="italic" fill="#d32f2f">Q<tspan dy ="7" font-size="12">H</tspan></text>

                        <line x1="320" y1="190" x2="360" y2="190" stroke="#28a745" stroke-width="4" marker-end="url(#arrowhead-work)"></line>
                        <text x="410" y="198" font-family="sans-serif" font-size="24" font-style="italic" fill="#28a745">W</text>

                        <line x1="250" y1="225" x2="250" y2="260" stroke="#007bff" stroke-width="4" marker-end="url(#arrowhead-cold)"></line>
                        <text x="275" y="260" font-family="sans-serif" font-size="24" font-style="italic" fill="#007bff">Q<tspan dy ="7" font-size="12">C</tspan></text>

                        <line x1="220" y1="115" x2="180" y2="115" stroke="#fff200" stroke-width="4" marker-end="url(#arrowhead-diss)"></line>
                        <text x="50" y="120" font-family="sans-serif" font-size="16" font-style="italic" fill="#28a745">Dissipation</text>

                        <line x1="340" y1="200" x2="370" y2="220" stroke="#fff200" stroke-width="4" marker-end="url(#arrowhead-diss)"></line>
                        <text x="410" y="250" font-family="sans-serif" font-size="16" font-style="italic" fill="#28a745">Dissipation</text>

                    </svg>
                    <img id="piston-schematic" src="piston-close.svg" alt="Schematic of a steam engine piston" style="max-width: 100%; max-height: 100%;">
                </div>
            </div>
            <div class="interactive-page" data-page-index="3">
                <div class="reversibility-container">
                    <div class="parameter-display">
                        <div>Pressure: <br> <span id="pressure-val">1.67</span> atm</div>
                        <div>Volume: <br><span id="volume-val">1.20</span> L</div>
                        <div>Temperature: <br> <span id="temp-val">300</span> K</div>
                    </div>
                    <div class="piston-system">
                        <div class="cylinder">
                            <div id="piston" class="piston"></div>
                            <svg class="piston-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <rect id="piston-shaft" x="0" y="45" width="40" height="10" class="shaft" />
                                <rect x="90" y="40" width="10" height="20" class="opening" />
                            </svg>
                        </div>
                    </div>
                    <div class="slider-control">
                        <span>State A</span>
                        <input type="range" id="state-slider" min="0" max="100" value="0" step="1">
                        <span>State B</span>
                    </div>
                </div>
            </div>
            <div class="interactive-page" data-page-index="4">Interactive Content Page 5</div>
            <div class="interactive-page" data-page-index="5">Interactive Content Page 6</div>
            <div class="interactive-page" data-page-index="6">Interactive Content Page 7</div>
            <div class="interactive-page" data-page-index="7">Interactive Content Page 8</div>
            <div class="interactive-page" data-page-index="8">Interactive Content Page 9</div>
            <div class="interactive-page" data-page-index="9">Interactive Content Page 10</div>
            <div class="interactive-page" data-page-index="10">Interactive Content Page 11</div>
            <div class="interactive-page" data-page-index="11">Interactive Content Page 12</div>
            <div class="interactive-page" data-page-index="12"><h1 style='color: var(--active-section);'>ðŸŽ‰ You Did It! ðŸŽ‰</h1></div>

            <div id="popup-overlay" class="popup-overlay hidden"></div>

            <div id="hot-source-quiz" class="popup-quiz hidden">
                <h3>ðŸ”¥ Hot Source Quiz</h3>
                <p>What is the primary role of the "Hot Source" in a real steam engine?</p>
                <div class="quiz-options">
                    <label><input type="radio" name="hot_source_q" value="wrong1"> The wheels turning</label>
                    <label><input type="radio" name="hot_source_q" value="correct"> The burning fuel in the furnace</label>
                    <label><input type="radio" name="hot_source_q" value="wrong2"> The escaping steam</label>
                </div>
                <button class="nav-button quiz-submit-btn">Check Answer</button>
                <div class="feedback"></div>
                <button class="popup-close-btn">&times;</button>
            </div>

            <div id="cold-sink-quiz" class="popup-quiz hidden">
                <h3>ðŸ’¨ Cold Sink Quiz</h3>
                <p>What acts as the "Cold Sink" where waste heat is expelled?</p>
                <div class="quiz-options">
                    <label><input type="radio" name="cold_sink_q" value="correct"> The surrounding atmosphere</label>
                    <label><input type="radio" name="cold_sink_q" value="wrong1"> The water tank</label>
                    <label><input type="radio" name="cold_sink_q" value="wrong2"> The metal body of the engine</label>
                </div>
                <button class="nav-button quiz-submit-btn">Check Answer</button>
                <div class="feedback"></div>
                <button class="popup-close-btn">&times;</button>
            </div>

        </section>
    </main>

    <footer>
        <button id="prev-btn" class="nav-button">Previous</button>
        <button id="next-btn" class="nav-button">Next</button>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const learningContent = [
                // Section 1: 2 pages
                { section: 1, title: "Starting with Reality", text: "<i>Describing the physical phenomenon we wish to study</i><p>A locomotive engineer would like to know what temperature they need to maintain in the combustion chamber of a steam engine such that it runs with the highest efficiency or runs the longest for every unit of fuel?</p>" },
                { section: 1, title: "Isolating the system", text: "<i>Focusing where the conversion happens</i><p>Identify the part of the train where heat energy is primarily converted into mechanical motion to drive the wheels.</p>" },
                // Section 2: 3 pages
                { section: 2, title: "Idealization", text: "<i>using symbols to simplify</i><p>As we are mostly concerned about energy and its transfer, we can simplify a complex structure such as a steam locomotive engine in the form of symbols to make the flow of energy clear. As you can see, as there is no such thing as perfectly insulating or perfectly consucting materials, some amount of energy dissipates through the various components in the form of heat and sound</p>" },
                { section: 2, title: "Idealizing further", text: "<i>Removing variables</i><p>We want find the maximum theoretical value for efficiency, therefore, as we can only control dissipation upto a certain extent, it is beneficial to only take into account the parameters that we can control. These include the temperature of the source, and that of the sink(even this cannot be controled, but atleast can be measured with significant confidence), pressure and the volume. <br> <br> Simultaneously, we assume all dissipation to be zero. A consequence of this is that moving from one state A to another state B and then coming back to A will not result in a change in the parameters of A. This would not have been possible in a real scenario as dissipation will happen in both transitions resulting in deviation of some parameters when coming back. Such an idealized process where any change can essentially be reversed without affecting the parameters is called a <b>Reversible process</b> </p>" },
                { section: 2, title: "Idealized system", text: "<h3>Third Page</h3><p>The final system assuming no dissipation</p>" },
                // Section 3: 2 pages
                { section: 3, title: "Discretization", text: "<h3>Discretization</h3><p>Seperating the steps</p>" },
                { section: 3, title: "The Focus", text: "<h3>Choose</h3><p>Choose what steps will be required for the calculation of work done</p>" },
                // Section 4: 2 pages
                { section: 4, title: "Graphing", text: "<h3>Geometric Model</h3><p>Graphical representation</p>" },
                { section: 4, title: "The Shaded Area", text: "<h3>Second Page of Sec 4</h3><p>The shaded area explanation</p>" },
                // Section 5: 4 pages
                { section: 5, title: "The Math", text: "<h3>1</h3><p>Clarifying what we have to find and how to find it using basic thermodynamic principle</p>" },
                { section: 5, title: "Isothermal Work", text: "<h3>2</h3><p>Calculating the isothermal work</p>" },
                { section: 5, title: "Adiabatic work", text: "<h3>3</h3><p>mathematical representation of why the Adiabatic work is not being taken into account</p>" },
                { section: 5, title: "Maximum efficiency", text: "<h3>4</h3><p>Final equation for efficiency</p>" },
            ];

            let currentPageIndex = 0;
            const totalPages = learningContent.length;
            const header = document.querySelector('header');
            const textPanel = document.getElementById('text-panel');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const sectionBoxes = document.querySelectorAll('.section-box');
            const progressLineFg = document.getElementById('progress-arrow-fg');
            const interactivePages = document.querySelectorAll('.interactive-page');
            let sectionCenterPoints = [];

            function initializeInteractivity() {
                const trainContainer = document.getElementById('train-interaction-container');
                if(trainContainer) {
                    const trainHotspots = trainContainer.querySelectorAll('.hotspot');
                    const trainFeedback = document.getElementById('train-feedback');
                    const trainZoomSlider = document.getElementById('train-zoom-slider');
                    const trainZoomSliderContainer = document.getElementById('zoom-slider-container');
                    const trainImageScaler = document.getElementById('train-image-scaler');
                    const mainEngineImage = document.getElementById('main-engine-image');
                    const pistonSchematic = document.getElementById('piston-schematic');

                    trainHotspots.forEach(hotspot => {
                        hotspot.addEventListener('click', function() {
                            if (trainContainer.classList.contains('correctly-answered')) return;

                            if (this.dataset.correct === 'true') {
                                trainFeedback.textContent = 'Correct! Now use the slider to zoom in and reveal the schematic.';
                                trainFeedback.className = 'feedback correct';
                                trainZoomSliderContainer.classList.add('active');
                                trainContainer.classList.add('correctly-answered');
                            } else {
                                trainFeedback.textContent = 'Not quite. That\'s the ' + this.dataset.part + '. Try again!';
                                trainFeedback.className = 'feedback incorrect';
                            }
                        });
                    });

                    trainZoomSlider.addEventListener('input', function() {
                        if (!trainContainer.classList.contains('correctly-answered')) return;

                        const value = parseInt(this.value);
                        const maxZoom = 2.5;

                        if (value <= 50) {
                            const zoomProgress = value / 50.0;
                            const currentZoom = 1 + (maxZoom - 1) * zoomProgress;
                            trainImageScaler.style.transform = `scale(${currentZoom})`;
                            mainEngineImage.style.opacity = 1;
                            pistonSchematic.style.opacity = 0;
                        } else {
                            trainImageScaler.style.transform = `scale(${maxZoom})`;
                            const fadeProgress = (value - 50) / 50.0;
                            mainEngineImage.style.opacity = 1 - fadeProgress;
                            pistonSchematic.style.opacity = fadeProgress;
                        }
                    });
                }
                // --- Pop-up Quiz Interaction ---
                const popupOverlay = document.getElementById('popup-overlay');
                const allPopups = document.querySelectorAll('.popup-quiz');

                function openPopup(popupId) {
                    const popup = document.getElementById(popupId);
                    if (popup) {
                        popupOverlay.classList.remove('hidden');
                        popup.classList.remove('hidden');
                    }
                }

                function closeAllPopups() {
                    popupOverlay.classList.add('hidden');
                    allPopups.forEach(p => p.classList.add('hidden'));
                }

                // --- Reversibility Interaction ---
                const stateSlider = document.getElementById('state-slider');
                if (stateSlider) {
                    const piston = document.getElementById('piston');
                    const pressureVal = document.getElementById('pressure-val');
                    const volumeVal = document.getElementById('volume-val');
                    const tempVal = document.getElementById('temp-val'); // Kept for display

                    stateSlider.addEventListener('input', function() {
                        const sliderValue = parseInt(this.value); // 0 to 100

                        // Define arbitrary start and end points as percentages of the container width
                        const travelStart = 20; // Start at 20% from the left
                        const travelEnd = 25;   // End at 70% from the left
                        const travelRange = travelEnd - travelStart;

                        // Map the slider's 0-100 value to our new travel range
                        const pistonPosition = travelStart + (sliderValue / 100) * travelRange;
                        piston.style.left = `${pistonPosition}%`;

                        // Find the shaft and update its width to follow the piston
                        const shaft = document.getElementById('piston-shaft');
                        if(shaft) {
                            shaft.setAttribute('width', pistonPosition);
                        }

                        // Calculate Volume and Pressure based on the new range
                        // Let Volume range from 1.20L to 1.70L
                        const volume = 1.20 - (sliderValue / 100.0) * 0.5;
                        const pressure = 1.0 / volume; // P*V = 2.0 (our constant)
                        
                        // Update the display
                        pressureVal.textContent = pressure.toFixed(2);
                        volumeVal.textContent = volume.toFixed(2);
                    });
                }

                document.getElementById('hot-source-btn')?.addEventListener('click', () => openPopup('hot-source-quiz'));
                document.getElementById('cold-sink-btn')?.addEventListener('click', () => openPopup('cold-sink-quiz'));
                
                popupOverlay.addEventListener('click', closeAllPopups);
                document.querySelectorAll('.popup-close-btn').forEach(btn => btn.addEventListener('click', closeAllPopups));

                document.querySelectorAll('.quiz-submit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const parentPopup = this.closest('.popup-quiz');
                        const selectedAnswer = parentPopup.querySelector('input:checked');
                        const feedbackEl = parentPopup.querySelector('.feedback');

                        if (!selectedAnswer) {
                            feedbackEl.textContent = 'Please select an answer.';
                            feedbackEl.className = 'feedback incorrect';
                            return;
                        }
                        
                        if (selectedAnswer.value === 'correct') {
                            feedbackEl.textContent = 'Correct! Well done.';
                            feedbackEl.className = 'feedback correct';
                        } else {
                            feedbackEl.textContent = 'Not quite. Think about the source of energy or where waste goes.';
                            feedbackEl.className = 'feedback incorrect';
                        }
                    });
                });
            }

            function calculateSectionCenterPoints() {
                sectionCenterPoints = [];
                const svgWidth = 1200;
                const headerWidth = header.offsetWidth;
                if (headerWidth === 0) return;
                const scaleFactor = svgWidth / headerWidth;
                sectionBoxes.forEach(box => {
                    const rect = box.getBoundingClientRect();
                    const headerRect = header.getBoundingClientRect();
                    const centerX = (rect.left - headerRect.left + rect.width / 2) * scaleFactor;
                    sectionCenterPoints.push(centerX);
                });
            }

            function renderPage(pageIndex) {
                currentPageIndex = pageIndex;
                const currentPageData = learningContent[pageIndex];
                textPanel.innerHTML = `<h2>${currentPageData.title}</h2>${currentPageData.text}`;
                
                interactivePages.forEach((page, index) => {
                    page.classList.toggle('active-page', index === pageIndex);
                });

                if (currentPageIndex !== 1) {
                    const trainContainer = document.getElementById('train-interaction-container');
                    if(trainContainer) {
                        const trainFeedback = document.getElementById('train-feedback');
                        const trainZoomSlider = document.getElementById('train-zoom-slider');
                        const trainZoomSliderContainer = document.getElementById('zoom-slider-container');
                        const trainImageScaler = document.getElementById('train-image-scaler');
                        const mainEngineImage = document.getElementById('main-engine-image');
                        const pistonSchematic = document.getElementById('piston-schematic');
                        
                        trainContainer.classList.remove('correctly-answered');
                        trainFeedback.textContent = 'Click on the part where heat energy is converted into motion!';
                        trainFeedback.className = 'feedback';
                        trainZoomSliderContainer.classList.remove('active');
                        trainZoomSlider.value = "0";
                        trainImageScaler.style.transform = 'scale(1)';
                        if(mainEngineImage) mainEngineImage.style.opacity = 1;
                        if(pistonSchematic) pistonSchematic.style.opacity = 0;
                        } else if (currentPageIndex !== 4) {
                        // Reset popups
                        document.getElementById('popup-overlay')?.classList.add('hidden');
                        document.querySelectorAll('.popup-quiz').forEach(p => p.classList.add('hidden'));
                        } else if (currentPageIndex !== 5) {
                            // Reset reversibility slider
                            const stateSlider = document.getElementById('state-slider');
                            if (stateSlider) {
                                stateSlider.value = 0; // Set slider to the start
                                // Manually trigger the input event to reset the display
                                stateSlider.dispatchEvent(new Event('input'));
                            }
                        }
                    }
                
                
                updateSections(currentPageData.section);
                updateProgressBar();
                updateNavButtons();
                
            }

            function updateSections(currentSectionNumber) {
                sectionBoxes.forEach(box => {
                    const section = parseInt(box.dataset.section);
                    box.classList.remove('active', 'completed');
                    if (section < currentSectionNumber) box.classList.add('completed');
                    else if (section === currentSectionNumber) box.classList.add('active');
                });
            }

            function updateProgressBar() {
                if (sectionCenterPoints.length === 0) return;
                const currentSection = learningContent[currentPageIndex].section;
                const pagesInCurrentSection = learningContent.filter(p => p.section === currentSection);
                const firstPageOfSectionIndex = learningContent.findIndex(p => p.section === currentSection);
                const pagesCompletedInSection = currentPageIndex - firstPageOfSectionIndex;
                const progressWithinSection = pagesInCurrentSection.length > 1 ? pagesCompletedInSection / (pagesInCurrentSection.length - 1) : 1;
                const sectionIndexInArray = currentSection - 1;
                const startX = sectionIndexInArray > 0 ? sectionCenterPoints[sectionIndexInArray - 1] : 0;
                const endX = sectionCenterPoints[sectionIndexInArray];
                const currentX = startX + (endX - startX) * progressWithinSection;
                progressLineFg.setAttribute('x2', currentX);
            }

            function updateNavButtons() {
                prevBtn.disabled = currentPageIndex === 0;
                nextBtn.disabled = currentPageIndex === totalPages - 1;
            }

            prevBtn.addEventListener('click', () => { if (currentPageIndex > 0) renderPage(currentPageIndex - 1); });
            nextBtn.addEventListener('click', () => { if (currentPageIndex < totalPages - 1) renderPage(currentPageIndex + 1); });
            sectionBoxes.forEach(box => box.addEventListener('click', () => { const targetSection = parseInt(box.dataset.section); const firstPageOfSection = learningContent.findIndex(p => p.section === targetSection); const currentSection = learningContent[currentPageIndex].section; if(targetSection <= currentSection + 1) renderPage(firstPageOfSection); }));
            window.addEventListener('resize', () => { calculateSectionCenterPoints(); updateProgressBar(); });

            initializeInteractivity();
            calculateSectionCenterPoints();
            renderPage(0);
        });
    </script>
</body>
</html>